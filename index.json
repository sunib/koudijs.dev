[{"content":"Let\u0026rsquo;s say you just wanted to have a simple API-key for your nginx ingress. The if structures in nginx configs are an interesting way to do this. There might be more effecient ways to do this, but for now this will do.\nExample example-ingress.yaml:\napiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: some-ingress annotations: nginx.ingress.kubernetes.io/use-regex: \u0026#34;true\u0026#34; nginx.ingress.kubernetes.io/configuration-snippet: | if ($arg_api_key != \u0026#39;yourVerySecretKey\u0026#39;) { return 401 \u0026#39;Access denied!\u0026#39;; } if ($http_x_api_key != \u0026#39;yourVerySecretKey\u0026#39;) { return 401 \u0026#39;Access denied!\u0026#39;; } spec: ingressClassName: nginx tls: - hosts: - koudijs.dev secretName: tls-koudijs-dev rules: - host: koudijs.dev http: paths: - path: / pathType: Prefix backend: service: name: some-backend-service port: number: 80 Running it can off course be done by:\nkubectl apply -f example-ingress.yaml How does it work? The trick here is the nginx.ingress.kubernetes.io/configuration-snippet annotation. All ingresses are transformed into one big Nginx config file. It\u0026rsquo;s templated, and after some digging I found the actual place in the nginx proxy repo.\nWarning Please be warned that injecting other kinds of stuff could lead to dangerous situations. Please be aware that you - or some sysadmin - could configure allow-snippet-annotations: \u0026quot;false\u0026quot;, which might be wise. But it would also break the trick described in this blog!\n","permalink":"https://koudijs.dev/posts/ingress-api-key/","summary":"\u003cp\u003eLet\u0026rsquo;s say you just wanted to have a simple API-key for your nginx ingress. The if structures in \u003ca href=\"http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#if\"\u003enginx configs\u003c/a\u003e are an interesting way to do this. There might be more effecient ways to do this, but for now this will do.\u003c/p\u003e\n\u003ch2 id=\"example\"\u003eExample\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003eexample-ingress.yaml\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eapiVersion\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003enetworking.k8s.io/v1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003ekind\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003eIngress\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003emetadata\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#f92672\"\u003ename\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003esome-ingress\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#f92672\"\u003eannotations\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003enginx.ingress.kubernetes.io/use-regex\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003enginx.ingress.kubernetes.io/configuration-snippet\u003c/span\u003e: |\u003cspan style=\"color:#e6db74\"\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e      if ($arg_api_key != \u0026#39;yourVerySecretKey\u0026#39;) {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e        return 401 \u0026#39;Access denied!\u0026#39;;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e      }\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e      if ($http_x_api_key != \u0026#39;yourVerySecretKey\u0026#39;) {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e        return 401 \u0026#39;Access denied!\u0026#39;;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e      }\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003espec\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#f92672\"\u003eingressClassName\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003enginx\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#f92672\"\u003etls\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  - \u003cspan style=\"color:#f92672\"\u003ehosts\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    - \u003cspan style=\"color:#ae81ff\"\u003ekoudijs.dev\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003esecretName\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003etls-koudijs-dev\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#f92672\"\u003erules\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  - \u003cspan style=\"color:#f92672\"\u003ehost\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003ekoudijs.dev\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003ehttp\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      \u003cspan style=\"color:#f92672\"\u003epaths\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e      - \u003cspan style=\"color:#f92672\"\u003epath\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e/\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#f92672\"\u003epathType\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003ePrefix\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#f92672\"\u003ebackend\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          \u003cspan style=\"color:#f92672\"\u003eservice\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#f92672\"\u003ename\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003esome-backend-service\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#f92672\"\u003eport\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e              \u003cspan style=\"color:#f92672\"\u003enumber\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003e80\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eRunning it can off course be done by:\u003c/p\u003e","title":"Ingress API key"},{"content":"On this docker hub page you can find all functions containers. This will allow you to run your Azure Functions inside kubernetes.\nBut how do you set this up? What things are not included?\nFunctions in Azure itself Azure functions make it very easy to run your pieces of code in Azure.\nAs I currently see it: Microsoft divided \u0026lsquo;core\u0026rsquo; functions from hosting functions. The GUI inside Azure allows you to:\nAllows you to swap between different slots (but that switching actually causes short downtimes on your site, good topic for another blog) Use secrets from a keyvault in your application settings Host your function with custom domains Use keys to protect your HTTP functions with an api key App keys protect all HTTP functions Function keys protect specific HTTP functions Functions use an attribute (HttpTrigger(AuthorizationLevel.Anonymous)) to define which exact access right they need (could be anonymous) Support for keys Where the last function actuall is supported in the container as partly supported:\nhttps://github.com/Azure/azure-functions-host/issues/4147#issuecomment-477431016 https://martinbjorkstrom.com/posts/2020-02-12-testing-protected-azure-functions. https://docs.microsoft.com/en-us/azure/azure-functions/security-concepts#secret-repositories But the question is: do you want it. Having calls between functions secured with keys is actually tedious work if you have multiple functions that call each other. You can also just secure the outside-in traffic by putting a key on your ingress.\n","permalink":"https://koudijs.dev/posts/azure-function-auth-in-k8s/","summary":"\u003cp\u003eOn this \u003ca href=\"https://hub.docker.com/_/microsoft-azure-functions-base\"\u003edocker hub page\u003c/a\u003e you can find all functions containers. This will allow you to run your Azure Functions inside kubernetes.\u003c/p\u003e\n\u003cp\u003eBut how do you set this up? What things are not included?\u003c/p\u003e\n\u003ch2 id=\"functions-in-azure-itself\"\u003eFunctions in Azure itself\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"https://docs.microsoft.com/en-us/azure/azure-functions/\"\u003eAzure functions\u003c/a\u003e make it very easy to run your pieces of code in Azure.\u003c/p\u003e\n\u003cp\u003eAs I currently see it: Microsoft divided \u0026lsquo;core\u0026rsquo; functions from hosting functions. The GUI inside Azure allows you to:\u003c/p\u003e","title":"Azure functions auth in k8s"},{"content":"Company info I\u0026rsquo;m from the Netherlands and I registred my company at the dutch Chamber of Commerce (KvK).\nOffical company name: Koudijs IT: note that I will use koudijs.dev as registred trade name for all my consultancy work.\nKvK number: 97788708\n","permalink":"https://koudijs.dev/about/","summary":"\u003ch1 id=\"company-info\"\u003eCompany info\u003c/h1\u003e\n\u003cp\u003eI\u0026rsquo;m from the Netherlands and I registred my company at the dutch Chamber of Commerce (KvK).\u003c/p\u003e\n\u003cp\u003eOffical company name: \u003ccode\u003eKoudijs IT\u003c/code\u003e: note that I will use \u003ccode\u003ekoudijs.dev\u003c/code\u003e as registred trade name for all my consultancy work.\u003c/p\u003e\n\u003cp\u003eKvK number: 97788708\u003c/p\u003e","title":"About"}]